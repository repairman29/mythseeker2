#!/bin/bash

# MythSeeker Development Setup Script
# Fetches secrets from Google Secret Manager and creates .env.development

set -e

echo "ğŸ”§ Setting up MythSeeker development environment..."

# Check if gcloud is authenticated
if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
    echo "âŒ Error: Not authenticated with gcloud. Please run 'gcloud auth login' first."
    exit 1
fi

# Set the project
PROJECT_ID="mythseekers-rpg"
gcloud config set project $PROJECT_ID

# Create .env.development file
ENV_FILE=".env.development"

echo "# MythSeeker Development Environment" > "$ENV_FILE"
echo "# Generated by dev-setup.sh on $(date)" >> "$ENV_FILE"
echo "" >> "$ENV_FILE"

# Fetch Firebase API Key
echo "ğŸ“¡ Fetching Firebase API Key..."
FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret="firebase-api-key" 2>/dev/null)
if [ -n "$FIREBASE_API_KEY" ]; then
    echo "âœ… Firebase API Key fetched successfully"
    echo "VITE_FIREBASE_API_KEY=$FIREBASE_API_KEY" >> "$ENV_FILE"
else
    echo "âŒ Failed to fetch Firebase API Key"
    exit 1
fi

# Add other Firebase configuration
echo "VITE_FIREBASE_AUTH_DOMAIN=mythseekers-rpg.firebaseapp.com" >> "$ENV_FILE"
echo "VITE_FIREBASE_PROJECT_ID=mythseekers-rpg" >> "$ENV_FILE"
echo "VITE_FIREBASE_STORAGE_BUCKET=mythseekers-rpg.appspot.com" >> "$ENV_FILE"
echo "VITE_FIREBASE_MESSAGING_SENDER_ID=659018227506" >> "$ENV_FILE"
echo "VITE_FIREBASE_APP_ID=1:659018227506:web:82425e7adaf80c2e3c412b" >> "$ENV_FILE"
echo "VITE_GOOGLE_CLOUD_PROJECT_ID=mythseekers-rpg" >> "$ENV_FILE"
echo "VITE_APP_ENVIRONMENT=development" >> "$ENV_FILE"

# Fetch optional secrets if they exist
echo "ğŸ“¡ Fetching optional secrets..."

# OpenAI API Key
OPENAI_API_KEY=$(gcloud secrets versions access latest --secret="openai-api-key" 2>/dev/null)
if [ -n "$OPENAI_API_KEY" ]; then
    echo "âœ… OpenAI API Key fetched successfully"
    echo "VITE_OPENAI_API_KEY=$OPENAI_API_KEY" >> "$ENV_FILE"
else
    echo "âš ï¸  OpenAI API Key not found (optional)"
fi

# Vertex AI API Key
VERTEX_AI_API_KEY=$(gcloud secrets versions access latest --secret="vertex-ai-api-key" 2>/dev/null)
if [ -n "$VERTEX_AI_API_KEY" ]; then
    echo "âœ… Vertex AI API Key fetched successfully"
    echo "VITE_VERTEX_AI_API_KEY=$VERTEX_AI_API_KEY" >> "$ENV_FILE"
else
    echo "âš ï¸  Vertex AI API Key not found (optional)"
fi

echo ""
echo "âœ… Development environment setup complete!"
echo "ğŸ“ Created: $ENV_FILE"
echo ""
echo "ğŸš€ You can now run: npm run dev"
echo ""
echo "ğŸ“‹ Environment variables loaded:"
echo "   - Firebase API Key: âœ…"
echo "   - Firebase Auth Domain: âœ…"
echo "   - Firebase Project ID: âœ…"
echo "   - Firebase Storage Bucket: âœ…"
echo "   - Firebase Messaging Sender ID: âœ…"
echo "   - Firebase App ID: âœ…"
echo "   - Google Cloud Project ID: âœ…"
echo "   - App Environment: âœ…"
if [ -n "$OPENAI_API_KEY" ]; then
    echo "   - OpenAI API Key: âœ…"
else
    echo "   - OpenAI API Key: âŒ (not configured)"
fi
if [ -n "$VERTEX_AI_API_KEY" ]; then
    echo "   - Vertex AI API Key: âœ…"
else
    echo "   - Vertex AI API Key: âŒ (not configured)"
fi 